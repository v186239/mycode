# Paramiko SSH with RSA
Lab Objective
The objective of this lab is to learn to push commands across an SSH connection using Paramiko. This lab uses RSA keypairs to connect. However, Paramiko can also work with passwording.

Procedure
Open a terminal and create a directory to work in.

student@bchd:~$ mkdir /home/student/mycode/paramikosshrsa/

Move into the home directory.

student@bchd:~$ cd

Great. Now let's download a script that will build 4 separate SSH targets for us.

student@bchd:~$ wget https://static.alta3.com/projects/ansible/deploy/pexpress-setup.sh

Now download the script that will remove any of the virtual environments when we're done. This clean up script is called, max_teardown.sh

student@bchd:~$ wget https://static.alta3.com/projects/ansible/deploy/max-teardown.sh

Run the script to remove any old virtual environments from previous labs. Always run this script before you run the 'build' script.

student@bchd:~$ bash max-teardown.sh

Run the build script we downloaded to deploy our containers. ONLY IF this is the first time running the script will it take about four or five minutes. It will look like it is stuck, but it is not. Environments are being created! Go get a cup of coffee or something.

student@bchd:~$ bash pexpress-setup.sh

Once your environments are built, try pinging them. First bender.

student@bchd:~$ ping -c 1 10.10.2.3

Now try to ping fry.

student@bchd:~$ ping -c 1 10.10.2.4

Now try to ping zoidberg.

student@bchd:~$ ping -c 1 10.10.2.5

To make an SSH connection you'll need to copy your id_rsa.pub key into these machines! Use the following commands to do so:

student@bchd:~$ ssh-copy-id -i ~/.ssh/id_rsa.pub bender@10.10.2.3

student@bchd:~$ ssh-copy-id -i ~/.ssh/id_rsa.pub fry@10.10.2.4

student@bchd:~$ ssh-copy-id -i ~/.ssh/id_rsa.pub zoidberg@10.10.2.5

Paramiko allows python to work across SSH tunnels, we'll want to make sure that it is installed. This is supported by Python 2.7+ and 3.x releases, so everyone should feel at home using it. Read the documentation page here: http://www.paramiko.org/installing.html

student@bchd:~$ python3 -m pip install paramiko

Create a new script.

student@bchd:~/mycode/paramikosshrsa/$ vim learntossh.py

Copy and paste the following into your script:


#!/usr/bin/env python3

## import Paramiko so we can talk SSH
import paramiko
import os

## shortcut issuing commands to remote
def cmdissue(command_to_issue):
  ssh_stdin, ssh_stdout, ssh_stderr = sshsession.exec_command(command_to_issue)
  return ssh_stdout.read()

sshsession = paramiko.SSHClient()

############# IF YOU WANT TO CONNECT USING UN / PW #############
#sshsession.connect(server, username=username, password=password)
############## IF USING KEYS #################

## mykey is our private key
mykey = paramiko.RSAKey.from_private_key_file("/home/student/.ssh/id_rsa")

## if we never went to this SSH host add the fingerprint to the known host file
sshsession.set_missing_host_key_policy(paramiko.AutoAddPolicy())

## creds to connect
sshsession.connect(hostname="10.10.2.3", username="bender", pkey=mykey)

## a simple list of commands to issue across our connection
our_commands = ["touch sshworked.txt", "touch create.txt", "touch file3.txt", "ls"]

## cycle through our commands, and issue them on the far end
for x in our_commands:
  print(cmdissue(x))
Save and exit with :wq then run your script.

student@bchd:~/mycode/paramikosshrsa/$ python3 learntossh.py

Yuck. Those 'b' that are returned are because we need to decode the bytes of the string. The fix is always the same if you ever see this 'error'. Change the last line of your script to read like the following and it will go away:


   print(cmdissue(x).decode('utf-8'))
Okay, so our code currently works but it's horribly written. The object sshsession lives in a global space (outside of a function) so it can be acted up by our function... but that's not good design. Our code should be in a function, like main(). If we do that right now, it will break our code. We should also imagine that our function may have been designed by a second party, perhaps a junior developer on our team, and therefore is in a file outside our code. Let's create the code generated by our junior developer now.

student@bchd:~/mycode/paramikosshrsa$ vim jrprogrammer.py

Copy and paste the following into your code. Imagine this code was produced because you told a team member, "I need a function that expects to be passed a command and a Paramiko active session object. I want the command issued on the active session and then have standard output returned".


def cmdissue(toissue, activesession):
      ssh_stdin, ssh_stdout, ssh_stderr = activesession.exec_command(toissue)
      return ssh_stdout.read().decode('UTF-8')
Save and exit with :wq

Okay, now that the code lives within an external file we need to import into our code. The import statement is a vague way to pull in code. If we only use the keyword import, we need to reference the function in the imported jrprogrammer file as jrprogrammer.cmdissue(). If we are more specific with our import, from jrprogrammer import cmdissue, then we can call cmdissue() without referencing jrprogrammer.

student@bchd:~/mycode/paramikosshrsa$ vim learntossh_updated.py

Copy and paste the following into your code.


#!/usr/bin/env python3

## std library imports on top
import os

## 3rd party imports below
import paramiko

## work assigned to a junior programming asset on our team
from jrprogrammer import cmdissue

def main():
  ## create session object
  sshsession = paramiko.SSHClient()
  sshsession.set_missing_host_key_policy(paramiko.AutoAddPolicy())

  mykey = paramiko.RSAKey.from_private_key_file("/home/student/.ssh/id_rsa")
  
  ## create SSH connection
  sshsession.connect(hostname='10.10.2.3', username='bender', pkey=mykey)
  
  our_commands = ["touch sshworked.txt", "touch create.txt", "touch file3.txt", "ls"]
  
  for x in our_commands:
    ## call our imported function and save the value returned
    resp = cmdissue(x, sshsession)
    ## if returned response is not null, print it out
    if resp != "":
      print(resp)
  
  ## end the SSH connection
  sshsession.close()

if __name__ == '__main__':
  main()
Save and exit with :wq

Run your code. It should behave exactly like before you made any changes.

student@bchd:~/mycode/paramikosshrsa$ python3 learntossh_updated.py

CUSTOMIZATION REQUEST 01 - Create a function that collects input from a user and returns a list of commands that the user wishes to issue across the SSH tunnel. Replace the line our_commands = ["touch sshworked.txt", "touch create.txt", "touch file3.txt", "ls"] with this function call.

CUSTOMIZATION REQUEST 02 - Re-write the program to accept input from the user as to the IP address and username to use. The user should be able to continue to enter IP address and username combos until the word done is typed. Be sure the program explains these conditions to the user.

CUSTOMIZATION REQUEST 03 - Make the output returned by our command to be written out to a file, results.log. Be sure to provide some kind of explanation as to the host that the results were returned from.

When you finish, be sure to run the max-teardown.sh script, to clean up your virtual environments.

student@bchd:~$ bash ~/max-teardown.sh

If you're tracking your code in GitHub, issue the following commands:

cd ~/mycode
git add *
git commit -m "your commit message"
git push origin main
Type your username and password

